<h1><%= @driver.name %> (DID: <%= @driver.id %>)</h1>

<%# Calculate total earnings/ratings %>

<% total_earnings, total_ratings, total_trips = 0, 0, 0 %>
<% @driver.trips.each do |trip|  %>
  <% if !trip.is_archive && trip.rating %>
    <% total_earnings += [(trip.cost - 1.65) * 0.8, 0].max %>
    <% total_ratings += (trip.rating || 0) %>
    <% total_trips += 1 %>
  <% end %>
<% end %>

<h1>Driver Info:</h1>
<div>
  Name: <%= @driver.name %> <br>
  VIN: <%= @driver.vin %> <br>
  Status: <%= !@driver.is_active ? "DEACTIVATED" : @driver.available ? "AVAILABLE" : "UNAVAILABLE" %> <br>
  Total Earnings: $<%= total_earnings %> <br>
  Average Rating: <%= total_trips == 0 ? 0 : (total_ratings.to_f / total_trips).round(2) %>
</div>

<%# Deactivate driver if they have driven before, otherwise, delete %>
<div>
  <% if @driver.trips.empty? %>
    <%= button_to "DELETE", driver_path(@driver.id), method: :delete, data: {confirm: "This will permanently delete the driver from the datebase."} %>
  <% else %>
   <%= button_to "#{@driver.is_active ? "DEACTIVATE" : "ACTIVATE"}", driver_active_path(@driver.id, {source_call: "show"}), method: :patch, data: {confirm: "Are you sure you want to change the active status of the driver? #{@driver.name} has completed #{total_trips} and earned $#{total_earnings}."} %>
  <% end %>
</div>

<br>

<% if @driver.is_active %>
  <%= link_to "Edit Driver Info", edit_driver_path %>
<% end %>

<div>
  <ul>
    <% @driver.trips.each do |trip|  %>
      <% if !trip.is_archive %>
        <li>
          Trip ID: <%= link_to "#{trip.id} #{trip.rating.nil? ? "(In-progress)" : nil}", trip_path(trip.id) %> <br> 
          Date: <%= trip.date %> <br>
          Rating: <%= trip.rating %> <br>
          Cost: $<%= trip.cost %> <br>
          Passenger: <%= link_to "#{trip.passenger.name} (PID: #{trip.passenger_id})", passenger_path(trip.passenger_id) %> <br>
        </li>
      <% end %>
    <% end %>
  </ul>
</div>